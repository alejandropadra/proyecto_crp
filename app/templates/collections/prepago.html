{% extends 'layout.html' %}
{% from 'helpers/_forms.html' import render_field %}
{% block main %}
{% block estilos %}
<link rel="stylesheet" href="{{ url_for('static', filename = 'css/estilos_prepago.css') }}">
{% endblock%}

<input type="hidden" value="{{tolerancia['betrsdiv']}}" id="toleranciaDiv">
<input type="hidden" value="{{tolerancia['betrs']}}" id="toleranciaBs">
<input type="hidden" value="{{descuento_div }}" id="descuentoDiv">
<main class="px-3 py-5">

  <div class="container">

      <form class="form_main mt-3 " method = "POST" enctype="multipart/form-data" onsubmit="return validateFile()">
      <div class="row d-flex gap-4">

        <div class="contenedor col-xl-5 col-md-5 col-lg-5 col-sm-12 gap-1">
          
          <h5 class="etiqueta">RIF</h5>
          <div class="inputContainer position-relative">
            <i class="fa-solid fa-circle-user inputIcon"></i>
            {{ render_field(form.rif, class="inputField", id="rif", value =current_user.rif, placeholder="Ingrese su numero de RIF", readonly= readonly) }}
            
          </div>

          <h5 class="etiqueta">Empresa</h5>
          <div class="inputContainer position-relative">
            <i class="fa-solid fa-building inputIcon"></i>
            {{ render_field(form.empresa, class="inputField", id="empresa",value = current_user.username, placeholder="Nombre de la empresa", readonly= readonly) }}
          </div>

          
          <h5 class="etiqueta">Empresa Beneficiaria del Pago</h5>
          <div class="inputContainer position-relative">
            <i class="fa-solid fa-building-columns inputIcon"></i>
            {{ render_field(form.empresa_beneficiaria, class="inputField", id="empresa_beneficiaria", value="Corimon Pinturas, C.A.", readonly= readonly ) }}
          </div>
          <h5 class="etiqueta">Fecha de depósito</h5>
          <div class="inputContainer position-relative">
            <i class="fa-regular fa-calendar inputIcon"></i>
            {{ render_field(form.fecha_deposito, class="inputField", id="fecha" ) }}
          </div>
        </div>
        <!--onchange="javascript:seleccionar_empresa()"-->


        <div class="contenedor col-xl col-md col-lg col-sm-12">
          <h5 class="etiqueta">Seleccione el tipo de moneda</h5>
          <div class="d-flex justify-content-center gap-5 p-3">
            <label class="check">
              <p class="m-0 p-0">bs</p>
              {{ form.bolivares(class="divisa", id="check3", disabled=disabled) }}
              <div class="checkmark"></div>
            </label>

            <label class="check">
              <p class="m-0 p-0">$</p>
              {{ form.dolares(class="divisa", id="check2", disabled=disabled) }}
              <div class="checkmark"></div>
            </label>

            <label class="check">
              <p class="m-0 p-0">€</p>
              {{ form.euro(class="divisa", id="check1", disabled=disabled) }}
              <div class="checkmark"></div>
            </label>
          </div>

          <h5 class="etiqueta">Cuenta de banco a la cual se realizó el pago</h5>
          <div class="inputContainer position-relative mt-3">
            <div class="mensaje"><p>Por favor, seleccione un tipo de moneda para acceder a este campo</p></div>
            <i class="fa-solid fa-building-columns inputIcon"></i>
            {{ render_field(form.banco_receptor, class="inputField disabled", id="banco_receptor", disabled='disabled' ) }}
            {{ render_field(form.banco_receptor_dolar, class="inputField d-none", id="banco_receptor_dolar") }}
          </div>

          <div class="inputContainer position-relative d-flex flex-column">
            <h5 class="etiqueta">Ingrese el Número de Referencia del pago</h5>
            <i class="fa-solid fa-book-bookmark inputIcon"></i>
            {{ render_field(form.n_deposito, placeholder="Ingrese el número de referencia", class ="inputField", id="ref", required="", label_attr={"class": "label", "for": "ref"}, value=algo) }}
          </div>

          <div class="inputContainer position-relative d-flex flex-column">
            <h5 class="etiqueta">Cargue el soporte del Pago</h5>
            <i class="fa-regular fa-credit-card inputIcon"></i>
            <input type="file" name="archivo" id ="archivo" class="inputField" style="max-width: 100%;" accept=".jpg,.jpeg,.png,.pdf" required>
          </div>

          <div class="row w-100 gap-2">
            <div class="col p-0 d-flex gap-2">
              <div class=" w-100" id="divMontoNormal">
                <h5 class="etiqueta">Monto pagado</h5>
                <div class="inputContainer position-relative z-1">
                  <i class="bi bi-cash-stack inputIcon"></i>
                  <!--
                  <i class="fa-solid fa-hand-holding-dollar "></i>-->
                  {{ render_field(form.monto, class="inputField", id="monto", required="", min="0.01", step="0.01" , label_attr={"class": "label", "for": "monto"}) }}
                </div>
              </div>


              <div class=" w-50 d-none" id="montoDescuentoDivisa">
                <h5 class="etiqueta">Beneficio por pago en divisa ({{descuento_div}}%)</h5>
                <div class="inputContainer position-relative z-1">
                  <i class="bi bi-cash-stack inputIcon"></i>
                  <!--
                  <i class="fa-solid fa-hand-holding-dollar "></i>-->
                  {{ render_field(form.monto, class="inputField", id="montoMostrarDescuentoDivisa", readonly=readonly, min="0.01", step="0.01" , label_attr={"class": "label", "for": "monto"}) }}
                </div>
              </div>
              
            </div>

            <div class="col d-none p-0" id="montoDescuento">
              <h5 class="etiqueta">Beneficio por pago en divisa ({{descuento_div}}%)</h5>
              <span id="descuento_div" class="d-none">{{descuento_div }} </span>
              <div class="inputContainer position-relative z-1">
                <i class="bi bi-cash-stack inputIcon"></i>
                <!--
                <i class="fa-solid fa-hand-holding-dollar "></i>-->
                {{ render_field(form.monto, class="inputField", id="monto-descuento", min="0.01", step="0.01" , label_attr={"class": "label", "for": "monto"}, readonly=readonly) }}
              </div>
            </div>
          </div>
          
          <div class="d-flex w-100  justify-content-between position-relative">
            <div id="alert" class="alert-container2 z-2 bg-warning">
              <i class="bi bi-exclamation-circle h-100"></i>
              <span id="alert-message"></span>
            </div>
          </div>
        </div>


    <div class="col-12 bg-white contenedor lista-prepago">
      <!-- Header fijo fuera del área de scroll -->
      <div class="list-header">
        <div class="titulo d-flex gap-2">
          Cantidad de elementos seleccionados
          <p id="contadorElementos"></p>
        </div>
        <div class="titulo d-flex gap-2">
          Monto restante por abonar
          <p id="montoRestante">0.00</p>
          <span id="moneda"></span>
        </div>
      </div>

      <!-- Contenedor con scroll para las facturas -->
      <div class="facturas-contenedor px-2 py-2">
        {% for entregas in resultados %}
          {% if not entregas.vacio %}
          <div class="custom-checkbox-container checkbox-variant-2 factura w-100" data-encabezado='{{entregas["encabezado"]|tojson}}' data-items='{{ entregas["detalle"]["items"]|tojson }}''>
            <input type="checkbox" class="hidden-checkbox" style="display: none;" />
            <div class="checkbox-visual"></div>
            <div class="contenido-factura">
              <div class="d-flex justify-content-center w-100 align-items-center elemento-dentro p-2 my-3">
                <div class="d-flex align-items-center gap-1 valorFactura w-100 justify-content-center">
                  <h3 class="m-0">Fecha de Emisión:</h3>
                  <p class="">{{entregas['encabezado'].fecha_emision}}</p>
                </div>
              </div>

              <div class="row d-flex w-100 gap-2 align-items-center">
                <div class="col-12 col-lg-4 m-0  flex-grow-1 d-flex flex-column gap-2 px-1">
                  <div class="d-flex align-items-center gap-1 valorFactura w-100">
                    <h3 class="m-0">Número de Entrega:</h3>
                    <p class="">{{entregas['encabezado'].numero_entrega}}</p>
                  </div>

                  <div class="d-flex align-items-center gap-1 valorFactura w-100">
                    <h3 class="m-0">Número de Pedido:</h3>
                    <p class="">{{entregas['encabezado'].numero_pedido}}</p>
                  </div>
                </div>

                <div class="col-12 col-lg-4 m-0 p-0 flex-grow-1 d-flex flex-column gap-2 px-1" >
                  <div class="d-flex align-items-center gap-1 valorFactura w-100 ">
                    <h3 class="m-0"> {% if entregas['encabezado'].TieneDPP %} Monto con DPP (Bs): {%else%} Monto (Bs): {% endif %}</h3>
                    <p class="">{{"{:,.2f}".format(entregas['encabezado'].total_bolivares)}} </p>
                  </div>

                  <div class="d-flex align-items-center gap-1 valorFactura w-100">
                    <h3 class="m-0"> {% if entregas['encabezado'].TieneDPP %} Monto con DPP ($): {%else%} Monto ($): {% endif %}   </h3>
                    <p class=" textoMostrarDivisas">{{"{:,.2f}".format(entregas['encabezado'].total_dolares)}} </p>

                    <p class=" d-none arrowMostrarDivisas text-success" id="arrowMostrarDivisas">  
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-move-right-icon lucide-move-right"><path d="M18 8L22 12L18 16"/><path d="M2 12H22"/></svg>
                        
                        {%if entregas['encabezado'].TieneDPP %}
                          {{"{:,.2f}".format(entregas['encabezado'].base_bono_dpp)}}
                        {%else%}
                          {{"{:,.2f}".format(entregas['encabezado'].base_bono_sin_dpp)}}
                        {%endif%}
                        <span></span>
                    </p> 
                  </div>
                </div>





                <div class="col-12 col-lg-2 p-0">
                  <button type="button" class="details verDetallesBtn" data-encabezado='{{entregas|tojson}}'>
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                    ver detalles
                  </button>
                </div>
              </div>
            </div>
          </div>


          {% else %}
          <div class="alert alert-warning d-flex align-items-center" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <div>
              No hay entregas disponibles para prepago en este momento.
            </div>
          {% endif %}

        {% endfor %}

        
      </div>
    </div>
    



      




      </div>

        <div class="mb-2 w-100 d-flex justify-content-center" style="margin-top: 25px; padding-bottom: 100px;">

        <input type="hidden" id="csrf" name="csrf_token" value="{{ csrf_token() }}"/>
        <button type="button" class="submit" id="activarModal" >
          <span>Enviar</span>
        </button>
      </div>

    </form>
  </div>
<!--id="enviarBoton" -->


  <div id="invoiceModal" class="modal">
    <div class="modal-content">
        <div class="invoice-header">
            <button class="close-btn-modal"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
            <h3 class=" m-0">Detalles de la Entrega</h3>
        </div>
        <div class="invoice-body">
          <!-- Sección de resumen (tu código existente) -->
          <h3 class="section-title">Resumen</h3>
          <div class="invoice-info">
            <div class="info-item">
              <div class="info-label">Número de entrega</div>
              <div class="info-value" id="numeroEntregaModal">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Fecha de Emisión</div>
              <div class="info-value" id="fechaEmisionModal">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Número de pedido</div>
              <div class="info-value" id="numeroPedidoModal">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Tasa de Cambio</div>
              <div class="info-value" id="tasaCambioModal">-</div>
            </div>

            <div class="info-item">
              <div class="info-label">Total de Articulos</div>
              <div class="info-value" id="numeroItemsModal">-</div>
            </div>

            <div class="info-item">
              <div class="info-label">Condición de Pago</div>
              <div class="info-value" id="condicionPagoModal">-</div>
            </div>


            <div class="info-item d-none" id="bonificacionPagoDivisaDiv">
              <div class="info-label">Bonificación pago en divisa</div>
              <div class="info-value" id="bonificacionPagoDivisaModal">-</div>
            </div>
          </div>


          <!-- Sección mejorada de items -->
          <div class=" py-3">
            <h3 class="section-title">Items</h3>
            <div class="table-container" id="tableConatiner">
              <!-- La tabla se generará aquí -->
            </div>
          </div>

        </div>
            

        </div>
    </div>


    <div id="invoiceModalVerificacion" class="modal">
      <div class="modal-content">
          <div class="invoice-header">
              <button class="close-btn-modal close-modal-verificacion"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
              <h3 class=" m-0">Verificación del proceso</h3>
          </div>
          <div class="invoice-body">
            <!-- Resumen General -->
            <h3 class="section-title">Resumen</h3>
            <div class="resumen-general">
              <div class="resumen-card">
                <div class="resumen-icon azul_byk d-flex align-items-center justify-content-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-box-icon lucide-box"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg></div>
                <div class="resumen-info">
                    <span class="resumen-label">Total Entregas</span>
                    <span class="resumen-value" id="totalEntregas">0</span>
                </div>
              </div>
              <div class="resumen-card">
                <div class="resumen-icon verde_dolar" id="text-icon">$</div>
                <div class="resumen-info">
                    <span class="resumen-label">Monto Pagado</span>
                    <span class="resumen-value" id="total">$0.00</span>
                </div>
              </div>
            </div>

            <div class="invoice-info resumen-card-detalles">
              <div class="info-item">
                <div class="info-label">Rif</div>
                <div class="info-value" id="RifValidacion">-</div>
              </div>
              <div class="info-item">
                <div class="info-label">Fecha del Depósito:</div>
                <div class="info-value" id="fechaValidacion">-</div>
              </div>
              <div class="info-item">
                <div class="info-label">Cuenta de banco</div>
                <div class="info-value" id="cuentaValidacion">-</div>
              </div>
              <div class="info-item">
                <div class="info-label">Número de Referencia:</div>
                <div class="info-value" id="refValidacion">-</div>
              </div>
            </div>

            <!-- Sección de entregas -->
            <h3 class="section-title">Entregas Seleccionadas</h3>
            
            <div id="listaEntregas" class="entregas-container">
                <!-- Las entregas se insertarán aquí dinámicamente -->
            </div>

            <div class="modal-actions">
              <button class="btn-secondary close-modal-verificacion ">Cancelar</button>
              <button class="btn-primary" id="enviarBoton">Confirmar Proceso</button>
            </div>

            
        </div>
        </div>
      </div>
</main>


{% endblock %}

{% block js%}
<script src="{{ url_for('static', filename='js/prepago.js') }}"></script>
    
{% endblock %}

